<body>
    <button onclick="start()">start</button>
    <!-- Visualizer container -->
    <canvas id='canvas'></canvas>
</body>
<script>

    function start() {

        canvas = document.getElementById("canvas");
        canvas.width = window.innerWidth;
        canvas.height = 300;
        ctx = canvas.getContext("2d");
        WIDTH = canvas.width;
        HEIGHT = canvas.height;

        var liveSource;
        var splitter;

        var context = new AudioContext();

        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
            .then(stream => {

                liveSource = context.createMediaStreamSource(stream);

                node = context.createScriptProcessor(16384, 2, 2);

                splitter = context.createChannelSplitter(2);

                liveSource.connect(splitter);

                liveSource.connect(node);

                liveSource.connect(context.destination);

                node.connect(context.destination);

                inChannels = context.destination.channelCount;
                outChannels = context.destination.channelCount;
                console.log(inChannels);
                console.log(outChannels);

                node.onaudioprocess = function (e) {

                    var input1 = e.inputBuffer.getChannelData(0),
                        len1 = input1.length,
                        total1 = i1 = 0,
                        rms1;
                    while (i1 < len1) 
                        total1 += Math.abs(input1[i1++]);
                    rms1 = Math.sqrt(total1 / len1);
                    
                    var input2 = e.inputBuffer.getChannelData(1),
                        len2 = input2.length,
                        total2 = i2 = 0,
                        rms2;
                    while (i2 < len2) 
                        total2 += Math.abs(input2[i2++]);
                    rms2 = Math.sqrt(total2 / len2);

                    console.log(rms1 + ", " + rms2);

                    var dataArray = [...e.inputBuffer.getChannelData(0), ...e.inputBuffer.getChannelData(1)]

                    var parentcanvas = document.getElementById('parentcanvas');
                    if (parentcanvas == null) {
                        parentcanvas = document.createElement('div');
                        document.getElementsByTagName('body')[0].after(parentcanvas);
                        parentcanvas.id = 'parentcanvas';
                    }
                    parentcanvas.style.position = 'relative';
                    parentcanvas.style.display = 'inline-block';
                    parentcanvas.style.width = 'calc(100%)';
                    parentcanvas.style.height = '100px';
                    parentcanvas.style.left = '0px';
                    parentcanvas.style.top = '0px';
                    parentcanvas.style.backgroundColor = '#000';
                    var canvas = document.getElementsByTagName('canvas');
                    if (canvas.length == 0) {
                        canvas = document.createElement('canvas');
                        parentcanvas.append(canvas);
                        canvas.id = 'canvas';
                    }
                    canvas = document.getElementById('canvas');
                    canvas.width = parentcanvas.clientWidth;
                    canvas.height = parentcanvas.clientHeight;
                    var WIDTH = canvas.width;
                    var HEIGHT = canvas.height;
                    var ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, WIDTH, HEIGHT);
                    var audiorawdata = dataArray;
                    var barWidth = WIDTH / dataArray.length;
                    var barHeight = HEIGHT;
                    var x = 0;
                    for (var i = 1; i < dataArray.length; i += 1) {
                        barHeight = audiorawdata[i] * 200;
                        ctx.fillStyle = '#ddd';
                        ctx.strokeStyle = '#ddd';
                        ctx.fillRect(x, HEIGHT / 2 - barHeight / 2, barWidth, barHeight / 2);
                        ctx.fillRect(x, HEIGHT / 2 + barHeight / 2, barWidth, -barHeight / 2);
                        x += barWidth;
                    }
                    ctx.stroke();
                }
            })
            .catch();
    }
</script>